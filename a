from pyspark.sql import SparkSession
from pyspark.sql import functions as F

spark = SparkSession.builder \
    .appName("NYC Taxi - Iceberg Ingestion (Jupyter)") \
    .config("spark.jars.packages", 
            "org.apache.iceberg:iceberg-spark-runtime-4.0_2.13:1.10.1") \
    .config("spark.sql.extensions", 
            "org.apache.iceberg.spark.extensions.IcebergSparkSessionExtensions") \
    .config("spark.sql.catalog.spark_catalog", 
            "org.apache.iceberg.spark.SparkSessionCatalog") \
    .config("spark.sql.catalog.spark_catalog.type", "hadoop") \
    .config("spark.sql.catalog.spark_catalog.warehouse", 
            "/home/aashishvinu/tasks/simple_scala_spark_job/data/warehouse") \
    .getOrCreate()

print("Spark session created successfully!")
spark


input_path = "/home/aashishvinu/tasks/simple_scala_spark_job/data/input/yellow_tripdata_2025-02.parquet"

print("=== Reading raw data ===")
raw_df = spark.read \
    .option("mergeSchema", "true") \
    .option("pathGlobFilter", "*.parquet") \
    .parquet(input_path)

raw_df.printSchema()
print(f"Raw record count: {raw_df.count():,}")
raw_df.show(5, truncate=False)

c_df = raw_df.select(F.col("tpep_pickup_datetime"))
c_df.show()


print("=== Cleaning & renaming columns ===")

cleaned_df = raw_df \
    .withColumnRenamed("tpep_pickup_datetime", "pickup_datetime") \
    .withColumnRenamed("tpep_dropoff_datetime", "dropoff_datetime") \
    .withColumnRenamed("PULocationID", "pickup_location_id") \
    .withColumnRenamed("DOLocationID", "dropoff_location_id") \
    .select([F.col(c).alias(c.lower()) for c in raw_df.columns]) \
    .na.drop(subset=["pickup_datetime", "dropoff_datetime", "trip_distance", "fare_amount"]) \
    .filter((F.col("trip_distance") > 0) & (F.col("fare_amount") > 0) & (F.col("total_amount") > 0))

cleaned_df.printSchema()

print(f"Cleaned record count: {cleaned_df.count():,}")
cleaned_df.show(5, truncate=False)


spark-submit --class IngestionJob --packages org.apache.iceberg:iceberg-spark-runtime-4.0_2.13:1.10.1 target/scala-2.13/nyc-taxi-iceberg-assembly-1.0.jar